<?php

$configHelper = $this->helper('TurnTo\SocialCommerce\Helper\Config');

$siteKey = $configHelper->getSiteKey();
$url = $configHelper->getUrl();
$staticUrl = $configHelper->getStaticUrl();
$urlWithoutProtocol = $configHelper->getUrlWithoutProtocol();
$staticUrlWithoutProtocol = $configHelper->getStaticUrlWithoutProtocol();
$setupType = $configHelper->getSetupType();
$reviewSetupType = $configHelper->getReviewsSetupType();
$version = $configHelper->getTurnToVersion();

$reviewsEnabled = $configHelper->getReviewsEnabled();
$qaEnabled = $configHelper->getQaEnabled();
$reviewsTeaserEnabled = $configHelper->getReviewsTeaserEnabled();
$qaTeaserEnabled = $configHelper->getQaTeaserEnabled();

$productSku = $this->getProduct()->getSku();

if ($reviewsEnabled || $qaEnabled):
?>

<script type="text/javascript">
    <?php
        if($qaTeaserEnabled && $qaEnabled):
    ?>
    function qaTeaser (){
        if(typeof(TurnToItemData) == 'undefined' || typeof(TurnToItemData.counts) == 'undefined') {
            return '';
        } else {
            var answerCount = TurnToItemData.counts.a;
            var questionCount = TurnToItemData.counts.q;
            var teaserContainer = TurnTojQuery(".TurnToItemTeaser");
            var teaserHtml = '';
            <?php
                if ($qaEnabled && $qaTeaserEnabled && $reviewsEnabled && $reviewsTeaserEnabled):
            ?>
            var teaserHtml = ' | ';
            <?php
                endif;
            ?>

            if(questionCount == 0) {
                teaserHtml = teaserHtml + '<a id="askQuestion" href="javascript:void(0)"><?= __('Ask a Question') ?></a>';
            } else {
                teaserHtml = teaserHtml + '<a id="readQuestions" href="javascript:void(0)">' + questionCount + ' Question' + (questionCount == 1 ? '' : 's') + ', ' + answerCount + ' Answer' + (answerCount == 1 ? '' : 's') + '</a>';
            }

            var reviewCount = TurnToItemData.counts.r;

            // Fill container with Q&A content
            teaserContainer.html(teaserHtml);

            // Add the appropriate listeners to the links
            scrollToTab(teaserContainer, '#askQuestion', '#turnto_qa','#tab-label-turnto_qa-title');

            scrollToTab(teaserContainer, '#readQuestions', '#turnto_qa','#tab-label-turnto_qa-title');
        }
    }

    <?php
        endif;

        if($reviewsTeaserEnabled && $reviewsEnabled):
    ?>

    function reviewsTeaser() {
        if(typeof(TurnToItemData) == 'undefined' || typeof(TurnToItemData.counts) == 'undefined') {
            return '';
        } else {
            var reviewCount = TurnToItemData.counts.r;
            var teaserContainer = TurnTojQuery(".TurnToReviewsTeaser");
            var teaserHtml = '';

            // round the average rating to the nearest tenth
            var rating = Math.round((TurnToItemData.counts.ar + 0.25) * 100.0) / 100.0;
            rating = rating.toString();
            var decimal = parseInt(rating.substring(2, 3))
            rating = rating.substring(0, 1) + "-" + (decimal >= 5 ? '5' : '0')

            if(reviewCount == 0) {
                teaserHtml = '<div class="TT2left TTratingBox TTrating-0-0"></div> <a id="writeReview" href="javascript:void(0)"><?= __('Write a Review') ?></a>';
            } else {
                teaserHtml = '<div class="TTratingBox TTrating-' + rating + '"></div><a id="readReviews" href="javascript:void(0)">' + reviewCount + ' Review' + (reviewCount == 1 ? '' : 's') + '</a>';
            }

            teaserContainer.html(teaserHtml);

            scrollToTab(teaserContainer, '#readReviews', '#turnto_reviews', '#tab-label-turnto_reviews-title');

            // Listener on 'write review' link
            teaserContainer.find('#writeReview').click(function(e) {
                TurnTo.writeReview();
            });
        }
    }
    <?php
        endif;
    ?>

    function scrollToTab(teaserContainer, clickElement, container, tab) {
        teaserContainer.find(clickElement).click(function(e) {
            e.preventDefault();
            if(!jQuery(tab).parent().hasClass('active')) {
                jQuery(tab).click();
            }
            jQuery("html, body").animate({ scrollTop: jQuery(container).offset().top - 20 }, 1000);
        });
    }

    var turnToConfig = {
        siteKey: "<?= $siteKey ?>",
        host: "<?= $urlWithoutProtocol ?>",
        staticHost: "<?= $staticUrlWithoutProtocol ?>",
        skipCssLoad: false,
        <?php
            if ($qaEnabled) {
                echo "setupType: \"" . $setupType . "\",";

                if ($qaTeaserEnabled) {
                    echo "iTeaserFunc: qaTeaser,";
                }
            }
            if ($reviewsEnabled) {
                echo "reviewsSetupType: \"" . $reviewSetupType . "\",";
                if ($reviewsTeaserEnabled) {
                    echo "reviewsTeaserFunc: reviewsTeaser,";
                }
            }
        ?>
    };

    (function() {
        var tt = document.createElement('script');
        tt.type = 'text/javascript';
        tt.async = true;
        tt.src = "<?= $staticUrl ?>/traServer<?= $version ?>/trajs/" + turnToConfig.siteKey + "/tra.js";
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(tt, s);
    })();

    var TurnToItemSku = "<?= $productSku ?>";
</script>

<script type="text/javascript" src="<?= $staticUrl ?>/sitedata/<?= $siteKey ?>/v<?= $version ?>/<?= $productSku ?>/d/itemjs"></script>

<?php
    endif;
?>